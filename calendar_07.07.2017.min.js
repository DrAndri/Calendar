function createCookie(e,t,n){var a="";if(n){var i=new Date;i.setTime(i.getTime()+24*n*60*60*1e3),a="; expires="+i.toUTCString()}document.cookie=e+"="+t+a+"; path=/"}function readCookie(e){for(var t=e+"=",n=document.cookie.split(";"),a=0;a<n.length;a++){for(var i=n[a];" "==i.charAt(0);)i=i.substring(1,i.length);if(0==i.indexOf(t))return i.substring(t.length,i.length)}return null}function eraseCookie(e){createCookie(e,"",-1)}function onFocus(){socket?$("#calendar").weekCalendar("refresh"):location.reload()}function setRecurringVisibility(e){e?($j("#switch-week-or-picker").show(),$j("#recurringOptions").slideDown(),recurringIsVisible=!0,$("#recurringOptionsButton").html("Cancel repeat")):($j("#recurringOptions").slideUp("default",function(){$("#recurringOptions").hide()}),$j("#switch-week-or-picker").hide(),recurringIsVisible=!1,$("#recurringOptionsButton").html("Repeat"))}function setWeekLineVisibility(e){e?($j("#switch-week-or-picker").html("Pick days"),$j("#week-series").slideDown(),$j("#days-series").slideUp(),weeklineIsVisible=!0):($j("#switch-week-or-picker").html("Weekly"),$j("#week-series").slideUp(),$j("#days-series").slideDown(),weeklineIsVisible=!1)}function resetForm(e){e.find("input").val(""),e.find("textarea").val(""),e.find("label[name='errorMsg']").empty(),e.find("#room-select").val("R"),$j("#weekline").weekLine("setSelected",""),setRecurringVisibility(!1),$("#recurringOptionsButton").html("Repeat"),$("#recurringOptionsButton").show(),$("#editAllOptions").hide(),$j("#editAllCheckbox").prop("checked",!1),editAll=!1}function toggleSettings(){settingsOpen?($("#side-menu").animate({left:"-25em"},500),$("#burger-menu").animate({left:"0"},300),$("#overlay").fadeOut(),settingsOpen=!1):($("#side-menu").animate({left:"0"},500),$("#burger-menu").animate({left:"10em"},600),$("#overlay").fadeIn(),settingsOpen=!0),$(this).toggleClass("open")}function setDaysToShow(){var e=$("#daysToShow-input").val();createCookie("daysToShow",e),$("#calendar").weekCalendar("setDaysToShow",e),ga("send",{hitType:"event",eventCategory:"Settings",eventAction:"daysToShow",eventLabel:e})}function setDaysToShow(){var e=$("#daysToShow-input").val();createCookie("daysToShow",e),$("#calendar").weekCalendar("setDaysToShow",e),ga("send",{hitType:"event",eventCategory:"Settings",eventAction:"daysToShow",eventLabel:e})}var socket=io.connect("http://starmyri.tk"),accessToken,users=[],nextFreeId=1,MILLISECONDS_IN_MINUTE=6e4,MINUTES_IN_DAY=1440,daysToShow=parseInt(null==readCookie("daysToShow")?Math.round(window.innerWidth/220):readCookie("daysToShow")),magicConfigTitle={data:users,typeDelay:10,maxSelection:1,maxDropHeight:100,maxSelectionRenderer:function(){return""},required:!0,placeholder:"Select or enter title",noSuggestionText:"5000/7500 kr per Ã¦fingu",strictSuggest:!0,useZebraStyle:!0};window.onfocus=onFocus;var recurringIsVisible=!1,weeklineIsVisible=!0,editAll=!1,$calendar,settingsOpen=!1;$(document).ready(function(){function e(e){e.start=new Date(1e3*e.start),e.end=new Date(1e3*e.end),e.body=e.body,e.title=e.title,e.body+="\rCreated by: "+e.creator;var t=new Date(e.end.getFullYear(),e.end.getMonth(),e.end.getDate(),o,0);if(e.end.getHours()<=o&&t.setDate(t.getDate()-1),t.getTime()<e.end.getTime()&&t.getTime()>e.start.getTime()){ga("send",{hitType:"event",eventCategory:"Events",eventAction:"eventOverlapsGrid"});var n=[],a=[];for(e.realId=e.id,e.realStart=new Date(e.start),e.realEnd=new Date(e.end),e.end=new Date(e.start),e.end.setHours(6),e.end.setMinutes(0),e.start.getHours()>=o&&e.end.setDate(e.end.getDate()+1),a.push(nextFreeId),e.id=nextFreeId++,n.push(Object.assign({},e)),e.start=new Date(e.end),e.end=new Date(e.end),e.end.setDate(e.end.getDate()+1);e.realEnd>e.end;)a.push(nextFreeId),e.id=nextFreeId++,n.push(Object.assign({},e)),e.start=new Date(e.end),e.end=new Date(e.end),e.end.setDate(e.end.getDate()+1);e.end=e.realEnd,a.push(nextFreeId),e.id=nextFreeId++,n.push(Object.assign({},e)),n.forEach(function(e){e.siblingsIds=a,$calendar.weekCalendar("updateEvent",e)})}else $calendar.weekCalendar("updateEvent",e)}function t(e){e.start=new Date(1e3*e.start),e.end=new Date(1e3*e.end),e.body+="\rEdited by: "+e.creator,$calendar.weekCalendar("updateEvent",e)}function n(e,t){return loggedIn&&(socket.emit("getAllEventsWithinTime",{start:e.getTime()/1e3,end:t.getTime()/1e3}),$("#calendar").weekCalendar("scrollToCurrentHour")),{events:[]}}function a(e,t,n,a){for(var i=0;i<a.length;i++){var r=a[i].start,s=a[i].end,o="";r.getTime()===n.start.getTime()&&(o='selected="selected"');var d="";s.getTime()===n.end.getTime()&&(d='selected="selected"'),e.append('<option value="'+r+'" '+o+">"+a[i].startFormatted+"</option>"),t.append('<option value="'+s+'" '+d+">"+a[i].endFormatted+"</option>")}$endTimeOptions=t.find("option"),e.trigger("change")}$("*").blur(),$("#burger-menu").click(toggleSettings),$j(".ms-trigger-ico").on("tap",function(){return!1}),$("#daysToShow-input").val(daysToShow),$j("#weekline").weekLine(),$j("#weekline").removeClass("weekDays-dark"),$j("#multi-datepicker").datepicker();var i=$j("#multi-datepicker").datepicker().data("datepicker");$("#editAllCheckbox").click(function(){editAll=this.checked}),socket.on("warning",function(e){console.log("warning"),console.log(e),checkLoginState()}),socket.on("events",function(t){if(t.events)for(var n=0;n<t.events.length;n++)e(t.events[n])}),socket.on("refresh",function(e){$("#calendar").weekCalendar("refresh")}),socket.on("editEvent",function(e){t(e.events)}),socket.on("deleteEvent",function(e){var t=e.events;$calendar.weekCalendar("removeEvent",t)}),socket.on("usernames",function(e){var t=0;for(t;t<e.bands.length;t++)users[t]={id:t,name:e.bands[t].bandName};for(var n=0;n<e.users.length;n++)"Tilraun Gaman"!=e.users[n].name&&(users[t]={id:t,name:e.users[n].name},t++)}),$calendar=$("#calendar");var r=new Date,s=r.getDay(),o=6,d=function(e){void 0!=e&&socket.emit("deleteEvent",{id:e})},l=function(e){void 0!=e&&socket.emit("deleteSeries",{series:e})},c=function(e){var t=e.get().split(":");return t[0]=parseInt(t[0]),t[1]=parseInt(t[1]),t},u=function(e,t){if(!isNaN(e.getTime())&&!isNaN(t.getTime()))if(O(e).getTime()>=O(t).getTime()){var n=c(S);n[1]+=15,h.set("min",n);var a=c(h);(n[0]>=a[0]||n[0]==a[0]&&n[1]>a[1])&&h.set("select",n)}else h.set("min",[0,0])},g=function(e,t){e.start=e.start.getTime()/1e3,e.end=e.end.getTime()/1e3,e.creator=name,e.published||(e.accessToken=accessToken),e.seriesStart&&e.seriesEnd?socket.emit("saveRecurringEventWithSeries",{recurringEvent:e,charge:t}):e.recurringDates?socket.emit("saveRecurringEventWithDates",{recurringEvent:e,charge:t}):socket.emit("saveEvent",{events:e,charge:t})},m=function(e,t){e.start=e.start.getTime()/1e3,e.end=e.end.getTime()/1e3,e.creator=name,e.published||(e.accessToken=accessToken),socket.emit("editEvent",{events:e,charge:t})},v=function(e){e.startChange/=1e3,e.endChange/=1e3,socket.emit("editRecurringEvent",e)},p=$j("#calendar-datepicker").pickadate({formatSubmit:"yyyy/mm/dd",format:"d. mmm",hiddenName:!0,onSet:function(e){null!=e.select&&$("#calendar").weekCalendar("gotoWeek",new Date(e.select))}});p.pickadate("picker");$j("#calendar-datepicker").off("focus");var f=$j("#end-datepicker").pickadate({formatSubmit:"yyyy/mm/dd",format:"d. mmm",hiddenName:!0,onSet:function(e){var t=new Date(e.select),n=new Date(T.get("select","yyyy/mm/dd"));u(n,t)}}),k=f.pickadate("picker"),y=$j("#end-timepicker").pickatime({interval:15,format:"HH:i",max:[23,59]}),h=y.pickatime("picker"),w=$j("#start-datepicker").pickadate({formatSubmit:"yyyy/mm/dd",format:"d. mmm",hiddenName:!0,onSet:function(e){var t=new Date(e.select),n=new Date(k.get("select","yyyy/mm/dd"));!isNaN(n.getTime())&&t.getTime()>n.getTime()&&k.set("select",t),k.set("enable",!0),k.set("disable",[{from:new Date(1970,1,1),to:new Date(e.select-MINUTES_IN_DAY*MILLISECONDS_IN_MINUTE)}]),u(t,n)}}),T=w.pickadate("picker"),b=$j("#start-timepicker").pickatime({format:"HH:i",min:[0,0],max:[23,59],interval:15,onSet:function(e){var t=new Date(T.get("select","yyyy/mm/dd")),n=new Date(k.get("select","yyyy/mm/dd"));u(t,n)}}),S=b.pickatime("picker"),C=$j("#series-end-datepicker").pickadate({formatSubmit:"yyyy/mm/dd",format:"d. mmm",hiddenName:!0}),E=C.pickadate("picker"),D=$j("#series-start-datepicker").pickadate({formatSubmit:"yyyy/mm/dd",format:"d. mmm",hiddenName:!0,onSet:function(e){E.set("disable",[{from:[0,0,0],to:new Date(e.select-MINUTES_IN_DAY*MILLISECONDS_IN_MINUTE)}])}}),I=D.pickadate("picker"),N=function(e,t){var n=new Date(e.get("select","yyyy/mm/dd"));if(t){var a=c(t);n.setHours(parseInt(a[0])),n.setMinutes(parseInt(a[1]))}return n},O=function(e){return new Date(e.getFullYear(),e.getMonth(),e.getDate(),0,0,0)};$calendar.weekCalendar({timeslotsPerHour:4,allowCalEventOverlap:!0,overlapEventsSeparate:!0,firstDayOfWeek:s-1,businessHours:{start:o,end:24+o,limitDisplay:!0},daysToShow:daysToShow,overflowHours:o,scrollToCurrentHourSubtract:2,height:function(e){return $(window).height()-$("h1").outerHeight()-1},eventRender:function(e,t){e.end.getTime()<(new Date).getTime()?(t.css("backgroundColor","#aaa"),t.find(".wc-time").css({backgroundColor:"#999",border:"1px solid #888"})):"L"===e.room?(t.css("backgroundColor","#B65700"),t.find(".wc-time").css({backgroundColor:"#5A2B00",border:"1px solid #64310C"})):"R"===e.room?(t.css("backgroundColor","#009200"),t.find(".wc-time").css({backgroundColor:"#004800",border:"1px solid #004A00"})):"B"===e.room&&(t.css("backgroundColor","#B60000"),t.find(".wc-time").css({backgroundColor:"#5A0000",border:"1px solid #640C0C"}))},draggable:function(e,t){return 1!=e.readOnly&&null==e.realId},resizable:function(e,t){return 1!=e.readOnly&&null==e.realId},eventNew:function(e,t){ga("send",{hitType:"event",eventCategory:"Events",eventAction:"newEvent - click"});var n=$("#event_edit_container");if(resetForm(n),e){T.set("select",e.start),k.set("select",e.end);var a=O(e.start),r=O(e.end);S.set("select",(e.start.getTime()-a.getTime())/MILLISECONDS_IN_MINUTE),h.set("select",(e.end.getTime()-r.getTime())/MILLISECONDS_IN_MINUTE)}else e={};var s=n.find("textarea[name='body']"),o=n.find("select[name='room']"),d=n.find("label[name='errorMsg']"),l=$j("#title").magicSuggest(magicConfigTitle);l.clear(),n.dialog({modal:!0,title:"New Calendar Event",width:500,open:function(e,t){$("input").blur(),$(".ui-dialog").focus()},close:function(){n.dialog("destroy"),n.hide(),$("#calendar").weekCalendar("removeUnsavedEvents")},buttons:{save:function(){setTimeout(function(){if(e.start=N(T,S),e.end=N(k,h),0==l.getSelection().length)return d.empty(),void d.append("Title is required");if(isNaN(e.start.getTime()))return d.empty(),void d.append("Please select start date");if(isNaN(e.end.getTime()))return d.empty(),void d.append("Please select end date");if(e.start>e.end)return d.empty(),void d.append("Event cannot start after it has ended...");for(var t=!1,a=0;a<l.getSelection().length;a++)null!=l.getSelection()[a].name&&(e.title=l.getSelection()[a].name,l.getSelection()[a].name==l.getSelection()[a].id&&(t=!0));e.body=s.val(),e.room=o.val(),e.published=1;var r="singleEvent";recurringIsVisible&&(weeklineIsVisible?(r="weekLine",e.seriesStart=N(I).getTime()/1e3,e.seriesEnd=N(E).getTime()/1e3,e.weekDays=$j("#weekline").weekLine("getSelected","indexes")):(r="datePicker",e.recurringDates=i.selectedDates)),ga("send",{hitType:"event",eventCategory:"Events",eventAction:"newEvent",eventLabel:r}),g(e,t),n.dialog("close")},200)},cancel:function(){n.dialog("close")}}}).show()},eventDrop:function(e,t){e.published=1,m(e),$calendar.weekCalendar("updateEvent",e),setTimeout(function(){},200),ga("send",{hitType:"event",eventCategory:"Events",eventAction:"dragged",eventLabel:e.id})},eventResize:function(e,t){e.published=1,m(e),$calendar.weekCalendar("updateEvent",e),setTimeout(function(){},200),ga("send",{hitType:"event",eventCategory:"Events",eventAction:"resized",eventLabel:e.id})},eventClick:function(e,t){if(ga("send",{hitType:"event",eventCategory:"Events",eventAction:"clicked",eventLabel:e.id}),!e.readOnly){var n=$("#event_edit_container");resetForm(n);var i=Object.assign({},e);$("#recurringOptionsButton").hide(),null!=e.series&&$("#editAllOptions").show(),e.start=e.realStart?e.realStart:e.start,e.end=e.realEnd?e.realEnd:e.end,T.set("select",e.start),k.set("select",e.end);var r=O(e.start),s=O(e.end);S.set("select",(e.start.getTime()-r.getTime())/MILLISECONDS_IN_MINUTE),h.set("select",(e.end.getTime()-s.getTime())/MILLISECONDS_IN_MINUTE);var c=n.find("textarea[name='body']");c.val(e.body);var u=n.find("select[name='room']").val(e.room),g=n.find("label[name='errorMsg']"),p=$j("#title").magicSuggest(magicConfigTitle);p.clear(),titleFieldPopulated=!1;for(var f=0;f<users.length;f++)users[f].name==e.title&&(p.setValue([f]),titleFieldPopulated=!0);titleFieldPopulated||p.setSelection([{name:e.title,id:e.title}]),n.dialog({modal:!0,title:"Edit - "+e.title,width:500,open:function(e,t){$("input").blur(),$(".ui-dialog").focus()},close:function(){n.dialog("destroy"),n.hide(),$("#calendar").weekCalendar("removeUnsavedEvents")},buttons:{save:function(){setTimeout(function(){if(e.start=N(T,S),e.end=N(k,h),e.start<e.end){if(0==p.getSelection().length)return g.empty(),void g.append("Title is required");for(var t=!1,a=0;a<p.getSelection().length;a++)null!=p.getSelection()[a].name&&(e.title=p.getSelection()[a].name,p.getSelection()[a].name==p.getSelection()[a].id&&(t=!0));if(e.body=c.val(),e.room=u.val(),e.published=1,e.realId&&(e.id=realId,e.siblingsIds.forEach(function(e){$calendar.weekCalendar("removeEvent",e)})),editAll){var r={};r.startChange=e.start-i.start,r.endChange=e.end-i.end,r.title=e.title,r.body=e.body,r.room=e.room,r.series=e.series,ga("send",{hitType:"event",eventCategory:"Events",eventAction:"updateRecurringEvent",eventLabel:e.id}),v(r)}else ga("send",{hitType:"event",eventCategory:"Events",eventAction:"updateEvent",eventLabel:e.id}),m(e,t);n.dialog("close")}else g.empty(),g.append("Event cannot start after it has ended...")},200)},delete:function(){e.realId?(d(e.realId),e.siblingsIds.forEach(function(e){$calendar.weekCalendar("removeEvent",e)})):editAll?(ga("send",{hitType:"event",eventCategory:"Events",eventAction:"deleteRecurringEvent",eventLabel:e.id}),l(e.series)):(ga("send",{hitType:"event",eventCategory:"Events",eventAction:"deleteEvent",eventLabel:e.id}),d(e.id)),n.dialog("close")},cancel:function(){n.dialog("close")}}}).show();var y=n.find("select[name='start']").val(e.start),w=n.find("select[name='end']").val(e.end);if(e.start.getHours()<=o){var b=new Date;b.setDate(e.start.getDate()),b.setHours(e.start.getHours()-o),a(y,w,e,$calendar.weekCalendar("getTimeslotTimes",b))}else a(y,w,e,$calendar.weekCalendar("getTimeslotTimes",e.start));$(window).resize().resize()}},eventMouseover:function(e,t){},eventMouseout:function(e,t){},noEvents:function(){},data:function(e,t,a){a(n(e,t))}}),setInterval(function(){$("#calendar").weekCalendar("refresh"),$("#calendar").weekCalendar("scrollToCurrentHour")},3e5)});